<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HARMONY TOWNSHIP DASHBOARD</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <style>
    /* General body and layout setup */
    html, body {
      margin: 0;
      padding: 0;
      height: 100vh;
      width: 100vw;
      font-family: Arial, sans-serif;
      overflow: hidden; /* Prevent scrolling on the main page */
    }
    body {
      display: flex;
      background: #000;
    }
    .toolbar {
      width: 250px;
      background: #000000;
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      padding: 20px 10px;
      flex-shrink: 0;
      z-index: 10;
    }
    .logo {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
    }
    .slides {
      flex-grow: 1;
      height: 100vh;
      position: relative;
    }
    .slide {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      transition: opacity 1s ease-in-out;
    }
    .slide.visible {
      opacity: 1;
    }
    .slide iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    .title {
      margin-top: 20px;
      font-size: 16px;
      text-align: center;
      font-weight: bold;
      text-transform: uppercase;
    }
    #nwsAlertOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      color: #ff4444;
      font-size: 42px;
      font-weight: bold;
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      z-index: 9999;
      visibility: hidden;
      padding: 20px;
      line-height: 1.3;
      opacity: 0;
      transition: visibility 0s, opacity 0.5s linear;
    }
    #nwsAlertOverlay.visible {
        visibility: visible;
        opacity: 1;
    }
    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }
      .toolbar {
        width: 100%;
        height: 150px;
        flex-direction: row;
        justify-content: space-around;
      }
      .slides {
        height: calc(100vh - 150px);
      }
      .title {
        display: none;
      }
      #nwsAlertOverlay {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>

  <div class="toolbar">
    <div>
      <img src="logo.png" alt="Harmony Township Logo" class="logo">
    </div>
    <iframe title="Common Ninja Widget" src="https://widgets.commoninja.com/iframe/c4d28163-89c5-4a2e-a0bd-1721d1a7018d" width="95%" height="100%" frameborder="0" scrolling="no"></iframe>
    <iframe title="Time and Date Clock" src="https://free.timeanddate.com/clock/ia164w8b/n805/fn2/fs30/fcfff/tct/pct/ftb/pb5/tt0/tw0/tm1/th1/tb4" frameborder="0" width="219" height="120" allowtransparency="true"></iframe>
  </div>

  <div class="slides" id="slidesContainer">
    <div class="slide"></div>
    <div class="slide"></div>
  </div>

  <div id="nwsAlertOverlay">ALERT MESSAGE</div>

  <audio id="alertSound"></audio>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <script src="config.js"></script>

  <script>
    // ------------------------------
    // Audio Context and Sound Generation
    // ------------------------------
    let audioEnabled = false;
    const alertSynth = new Tone.Synth({
        oscillator: { type: 'square' },
        envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.2 }
    }).toDestination();

    function playAlertSound() {
        if (!audioEnabled) return;
        const now = Tone.now();
        alertSynth.triggerAttackRelease('C5', '8n', now);
        alertSynth.triggerAttackRelease('G4', '8n', now + 0.2);
        alertSynth.triggerAttackRelease('C5', '8n', now + 0.4);
    }

    function enableAudio() {
      if (audioEnabled) return;
      Tone.start();
      audioEnabled = true;
      console.log('Audio context started.');
      window.removeEventListener('click', enableAudio);
      window.removeEventListener('keydown', enableAudio);
    }
    window.addEventListener('click', enableAudio);
    window.addEventListener('keydown', enableAudio);

    // ------------------------------
    // Slide Rotation Logic
    // ------------------------------
    const sources = [
      {
        iframe: '<iframe title="Maintenance" src="maintenance.html" frameborder="0" allowfullscreen="true"></iframe>',
        duration: 30000
      },
      {
        iframe: '<iframe title="Trainings" src="trainings.html" frameborder="0" allowfullscreen="true"></iframe>',
        duration: 30000
      },
      {
        iframe: '<iframe title="EMS Schedule" src="schedule.html" frameborder="0" allowfullscreen="true"></iframe>',
        duration: 30000
      },
      {
        iframe: '<iframe title="Google Slides" src="https://docs.google.com/presentation/d/e/2PACX-1vSwcRaDaFHcBYOPvLNlsNATIDRqoApsB1UX11rVQFwUcRkKrqxb12k4PaiV_IFS1I8LvI_uVw2uqY82/pubembed?start=true&loop=true&delayms=15000&rm=minimal" frameborder="0" width="1440" height="839" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true"></iframe>',
        duration: 60000
      },
      {
        iframe: `<iframe title="Weather Radar" src="https://embed.windy.com/embed.html?type=map&location=coordinates&metricRain=default&metricTemp=default&metricWind=mph&zoom=11&overlay=radar&product=radar&level=surface&lat=39.91&lon=-83.602" frameborder="0"></iframe>`,
        duration: 30000
      },
    ];

    const slideDivs = document.querySelectorAll('.slide');
    let contentIndex = 0;
    let activeSlideIndex = 0;

    function scheduleNextSlide(duration) {
        setTimeout(() => {
          contentIndex = (contentIndex + 1) % sources.length;
          rotateSlides();
        }, duration);
    }

    function rotateSlides() {
      const nextSlideIndex = 1 - activeSlideIndex;
      const currentSlide = slideDivs[activeSlideIndex];
      const nextSlide = slideDivs[nextSlideIndex];
      const source = sources[contentIndex];

      nextSlide.innerHTML = source.iframe;
      const iframe = nextSlide.querySelector('iframe');
      
      const transition = () => {
        if (nextSlide.classList.contains('visible')) return; // Prevent double-firing
        currentSlide.classList.remove('visible');
        nextSlide.classList.add('visible');
        activeSlideIndex = nextSlideIndex;
        scheduleNextSlide(source.duration);
      };
      
      iframe.onload = transition;
      iframe.onerror = () => {
        console.error("Iframe failed to load:", source.iframe);
        transition(); // Still transition to the (blank) slide to not stall the show
      };
      
      // Failsafe for iframes that might not fire 'load' (e.g., srcdoc, or cached content)
      setTimeout(() => transition(), 500);
    }

    function startRotation() {
      const firstSource = sources[0];
      slideDivs[0].innerHTML = firstSource.iframe;
      const firstIframe = slideDivs[0].querySelector('iframe');

      const transition = () => {
          if (slideDivs[0].classList.contains('visible')) return;
          slideDivs[0].classList.add('visible');
          activeSlideIndex = 0;
          setTimeout(() => {
              contentIndex = 1;
              rotateSlides();
          }, firstSource.duration);
      };

      firstIframe.onload = transition;
      firstIframe.onerror = () => {
          console.error("First iframe failed to load:", firstSource.iframe);
          transition();
      };
      setTimeout(() => transition(), 500); // Failsafe
    }

    startRotation();

    // ------------------------------
    // NWS Alert System
    // ------------------------------
    const shownAlerts = new Set();

    async function fetchNWSAlerts() {
      try {
        const zone = CONFIG.nwsAlertZone || 'OHZ053';
        const response = await fetch(`https://api.weather.gov/alerts/active/zone/${zone}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();

        if (data.features && data.features.length > 0) {
          for (const feature of data.features) {
            const alertId = feature.id;
            if (!shownAlerts.has(alertId)) {
              const alert = feature.properties;
              // Only show alerts with a certain severity
              if (['Severe', 'Extreme'].includes(alert.severity)) {
                  const message = `${alert.headline}`;
                  showNWSAlert(message, 60000); // Show alert for 60 seconds
                  shownAlerts.add(alertId);
                  break; // Show one new alert at a time to avoid overlap
              }
            }
          }
        }
      } catch (err) {
        console.error("NWS alert fetch failed:", err);
      }
    }

    function showNWSAlert(message, duration) {
      const overlay = document.getElementById("nwsAlertOverlay");
      overlay.textContent = message;
      overlay.classList.add('visible');
      playAlertSound();
      setTimeout(() => {
        overlay.classList.remove('visible');
      }, duration);
    }

    fetchNWSAlerts();
    setInterval(fetchNWSAlerts, 300000); // Poll every 5 minutes
  </script>
</body>
</html>