<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HARMONY TOWNSHIP DASHBOARD</title>
  <link rel="icon" type="image/x-icon" href="favicon6.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="manifest" href="manifest.json">
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    /* Custom font family */
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-900 text-white flex flex-col h-screen w-screen overflow-hidden">

  <!-- Main content area (sidebar + slides) -->
  <div class="flex-grow flex flex-col md:flex-row min-h-0">
    <!-- Toolbar / Sidebar -->
    <aside class="w-full md:w-64 bg-gray-800 text-white flex md:flex-col justify-around md:justify-between items-center p-4 md:p-5 flex-shrink-0 z-20 shadow-lg">
      <div class="flex flex-col items-center text-center">
        <img src="logo.png" alt="Harmony Township Logo" class="w-40 md:w-60 h-auto rounded-lg">
      </div>

      <!-- Weather Widget -->
      <div id="toolbar-weather-widget" class="text-center">
          <p id="weather-temp" class="text-6xl font-black">--°</p>
          <p id="weather-condition" class="text-2xl text-gray-300 mt-2">Loading...</p>
          <p id="weather-location" class="text-xl font-bold mt-2">South Vienna</p>
          <p id="weather-high-low" class="text-md text-gray-400">H: --° L: --°</p>
      </div>
      
      <!-- Clock Container -->
      <div id="clock-container" class="w-48 md:w-full h-20 transition-all duration-300 ease-in-out">
          <iframe title="Time and Date Clock" src="https://free.timeanddate.com/clock/ia164w8b/n805/fn2/fs30/fcfff/tct/pct/ftb/pb5/tt0/tw0/tm1/th1/tb4" frameborder="0" class="w-full h-full" allowtransparency="true"></iframe>
      </div>
    </aside>

    <!-- Main Content Slides -->
    <main class="flex-grow h-full relative">
      <div class="slides" id="slidesContainer">
        <div class="slide absolute inset-0 w-full h-full opacity-0 transition-opacity duration-1000 ease-in-out"></div>
        <div class="slide absolute inset-0 w-full h-full opacity-0 transition-opacity duration-1000 ease-in-out"></div>
      </div>
    </main>
  </div>


  <!-- IPAWS / NWS Alert Overlay -->
  <div id="ipawsAlertOverlay" class="fixed inset-0 bg-black bg-opacity-95 text-red-500 text-3xl md:text-5xl font-black flex justify-center items-center text-center z-[9999] p-5 leading-tight opacity-0 invisible transition-opacity duration-500">
    <!-- Alert content will be injected here -->
  </div>
  
  <!-- Ticker Iframe -->
  <footer id="ticker-footer" class="fixed bottom-0 left-0 w-full h-20 z-50 hidden">
    <iframe src="ticker.html" class="w-full h-full border-none"></iframe>
  </footer>


  <audio id="alertSound"></audio>

  <script src="config.js"></script>
  <!-- Firebase Libraries -->
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {

        // ------------------------------
        // Ticker Communication
        // ------------------------------
        window.addEventListener('message', (event) => {
            const tickerFooter = document.getElementById('ticker-footer');
            const clockContainer = document.getElementById('clock-container');
            
            if (event.data && typeof event.data.tickerActive !== 'undefined') {
                if (event.data.tickerActive) {
                    tickerFooter.classList.remove('hidden');
                    // Add margin to the clock on medium screens and up to avoid overlap
                    clockContainer.classList.add('md:mb-20');
                } else {
                    tickerFooter.classList.add('hidden');
                    // Remove the margin when ticker is inactive
                    clockContainer.classList.remove('md:mb-20');
                }
            }
        });

        // ------------------------------
        // Audio Context and Sound Playback
        // ------------------------------
        let audioEnabled = false;
        const alertAudioElement = document.getElementById('alertSound');

        // Maps the dropdown values to actual filenames.
        const toneFileMap = {
            'default': 'default.mp3',
            'alarm': 'alarm.mp3',
            'chime': 'chime.mp3',
            'ascending': 'ascending.mp3'
        };

        function playAlertSound(toneName = 'default') {
            if (!audioEnabled) {
              console.warn("Audio not enabled by user yet. Click anywhere to enable.");
              return;
            }
            const fileName = toneFileMap[toneName] || toneName;
            alertAudioElement.src = fileName;
            alertAudioElement.play().catch(error => {
              console.error(`Error playing sound "${fileName}":`, error);
              const overlay = document.getElementById("ipawsAlertOverlay");
              const errorSpan = document.createElement('span');
              errorSpan.textContent = ` [Audio file not found: ${fileName}]`;
              errorSpan.className = 'text-yellow-500 text-xl block mt-4';
              if (!overlay.querySelector('span')) {
                  overlay.appendChild(errorSpan);
              }
            });
        }

        function enableAudio() {
          if (audioEnabled) return;
          audioEnabled = true;
          alertAudioElement.src = "data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=";
          alertAudioElement.play().catch(()=>{});
          alertAudioElement.pause();
          alertAudioElement.currentTime = 0;
          console.log('Audio context started by user interaction.');
          window.removeEventListener('click', enableAudio);
          window.removeEventListener('keydown', enableAudio);
        }
        window.addEventListener('click', enableAudio);
        window.addEventListener('keydown', enableAudio);

        // ------------------------------
        // Slide Rotation Logic
        // ------------------------------
        const sources = [
          { type: 'googleslides', iframe: ``, duration: 20000 },
          { iframe: `<iframe title="Expiring Items" src="https://htfdclarkoh.github.io/apps/last10" frameborder="0" class="w-full h-full"></iframe>`, duration: 20000 },
          { iframe: `<iframe title="Expiring Items" src="https://htfdclarkoh.github.io/ems/expireditems" frameborder="0" class="w-full h-full"></iframe>`, duration: 20000 },
          { iframe: `<iframe title="Notable Addresses" src="addresses.html" frameborder="0" class="w-full h-full"></iframe>`, duration: 20000 },
          { iframe: `<iframe title="Weather Radar" src="weather_radar.html" frameborder="0" class="w-full h-full"></iframe>`, duration: 15000 },
          { iframe: '<iframe title="News Feed" src="news.html" frameborder="0" allowfullscreen="true" class="w-full h-full"></iframe>', duration: 20000 },
          { iframe: '<iframe title="Maintenance" src="maintenance.html" frameborder="0" allowfullscreen="true" class="w-full h-full"></iframe>', duration: 12000 },
          { iframe: '<iframe title="Trainings" src="googlecalander.html" frameborder="0" allowfullscreen="true" class="w-full h-full"></iframe>', duration: 15000 },
          { iframe: '<iframe title="EMS Schedule" src="schedule.html" frameborder="0" allowfullscreen="true" class="w-full h-full"></iframe>', duration: 20000 },
          { iframe: `<iframe title="Weather Forecast" src="weather.html" frameborder="0" class="w-full h-full"></iframe>`, duration: 15000 },
          { iframe: `<iframe title="Stats 1" src="stats1.html" frameborder="0" class="w-full h-full"></iframe>`, duration: 15000 },
          { iframe: `<iframe title="Road Closures/Work" src="map.html" frameborder="0" class="w-full h-full"></iframe>`, duration: 10000 },
          { iframe: `<iframe title="ODOT Cameras" src="ohgo.html" frameborder="0" class="w-full h-full"></iframe>`, duration: 30000 },
        ];

        const slideDivs = document.querySelectorAll('.slide');
        let contentIndex = 0;
        let activeSlideIndex = 0;
        
        async function setupGoogleSlides() {
            // ... (this function remains unchanged)
            const slidesConfig = CONFIG.googleSlides;
            const slidesSource = sources.find(s => s.type === 'googleslides');

            if (!slidesConfig || !slidesConfig.scriptUrl || slidesConfig.scriptUrl.includes('PASTE')) {
                console.error("Google Slides Apps Script URL is not configured in config.js. Using default duration and showing error message.");
                slidesSource.iframe = `<div class="w-full h-full flex items-center justify-center bg-gray-800 text-yellow-300 p-8 text-center text-2xl"><strong>Configuration Needed:</strong><br>Please set your Google Slides Apps Script URL in <strong>config.js</strong>.</div>`;
                return;
            }

            try {
                const response = await fetch(slidesConfig.scriptUrl, { cache: 'no-cache' });
                if (!response.ok) {
                    throw new Error(`Failed to fetch slide count. Status: ${response.status}. Ensure the script is deployed correctly with "Anyone" access.`);
                }
                const slideCount = parseInt(await response.text(), 10);
                if (isNaN(slideCount) || slideCount <= 0) {
                    throw new Error(`Invalid slide count received: ${slideCount}`);
                }

                const delayMs = slidesConfig.delayPerSlideSeconds * 1000;
                const totalDuration = slideCount * delayMs;
                const embedUrl = `${slidesConfig.embedUrlBase}&delayms=${delayMs}`;
                const iframeHtml = `<iframe title="Google Slides" src="${embedUrl}" frameborder="0" class="w-full h-full"></iframe>`;

                if (slidesSource) {
                    slidesSource.iframe = iframeHtml;
                    slidesSource.duration = totalDuration;
                    console.log(`Google Slides configured with ${slideCount} slides for a total duration of ${totalDuration / 1000}s.`);
                }

            } catch (error) {
                console.error("Error setting up Google Slides:", error);
                if(slidesSource){
                    slidesSource.iframe = `<div class="w-full h-full flex items-center justify-center bg-gray-800 text-red-400 p-8 text-center text-2xl"><strong>Error:</strong><br>Could not load Google Slides count.<br>${error.message}</div>`;
                }
            }
        }

        function scheduleNextSlide(duration) { setTimeout(() => { contentIndex = (contentIndex + 1) % sources.length; rotateSlides(); }, duration); }

        function rotateSlides() {
            // ... (this function remains unchanged)
            let source = sources[contentIndex];
            const initialIndex = contentIndex;
            while (source.duration === 0) {
                contentIndex = (contentIndex + 1) % sources.length;
                source = sources[contentIndex];
                if (contentIndex === initialIndex) { console.error("All slides have a duration of 0. Halting rotation."); return; }
            }
            const nextSlideIndex = 1 - activeSlideIndex;
            const currentSlide = slideDivs[activeSlideIndex];
            const nextSlide = slideDivs[nextSlideIndex];
            nextSlide.innerHTML = source.iframe;
            const iframe = nextSlide.querySelector('iframe');
            const transition = () => {
                if (nextSlide.classList.contains('opacity-100')) return;
                currentSlide.classList.remove('opacity-100');
                currentSlide.classList.add('opacity-0');
                nextSlide.classList.remove('opacity-0');
                nextSlide.classList.add('opacity-100');
                activeSlideIndex = nextSlideIndex;
                scheduleNextSlide(source.duration);
            };
            if (iframe) {
                iframe.onload = transition;
                iframe.onerror = () => { console.error("Iframe failed to load:", source.iframe); transition(); };
                setTimeout(transition, 500);
            } else {
                transition();
            }
        }

        async function startRotation() {
          await setupGoogleSlides(); 
          const firstSource = sources[0];
          slideDivs[0].innerHTML = firstSource.iframe;
          const transition = () => {
              if (slideDivs[0].classList.contains('opacity-100')) return;
              slideDivs[0].classList.remove('opacity-0');
              slideDivs[0].classList.add('opacity-100');
              activeSlideIndex = 0;
              setTimeout(() => { contentIndex = 1; rotateSlides(); }, firstSource.duration);
          };
          const firstIframe = slideDivs[0].querySelector('iframe');
          if(firstIframe) {
            firstIframe.onload = transition;
            firstIframe.onerror = () => { console.error("First iframe failed to load:", firstSource.iframe); transition(); };
             setTimeout(transition, 500);
          } else {
            transition();
          }
        }

        startRotation();
        
        if (CONFIG.googleSlides && CONFIG.googleSlides.refreshIntervalMinutes > 0) {
            const refreshIntervalMs = CONFIG.googleSlides.refreshIntervalMinutes * 60 * 1000;
            setInterval(async () => { console.log("Checking for Google Slides updates..."); await setupGoogleSlides(); }, refreshIntervalMs);
        }

        // ------------------------------
        // Remote & NWS Alert System
        // ------------------------------
        const IPAWS_CONFIG = {
            ZONE: CONFIG.nwsAlertZone,
            REFRESH_INTERVAL_SECONDS: 300
        };
        const shownAlerts = new Set();
        
        function showIPAWSAlert(message, duration, toneName = 'default') {
          const overlay = document.getElementById("ipawsAlertOverlay");
          overlay.innerHTML = message;
          overlay.classList.remove('invisible', 'opacity-0');
          overlay.classList.add('opacity-100');
          playAlertSound(toneName);
          setTimeout(() => {
            overlay.classList.remove('opacity-100');
            overlay.classList.add('invisible', 'opacity-0');
          }, duration);
        }

        async function fetchIPAWSAlerts() {
          try {
            const response = await fetch(`https://api.weather.gov/alerts/active/zone/${IPAWS_CONFIG.ZONE}`);
            if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
            const data = await response.json();
            const newAlertMessages = [];
            if (data.features && data.features.length > 0) {
              for (const feature of data.features) {
                const alertId = feature.id;
                if (!shownAlerts.has(alertId)) {
                  newAlertMessages.push(feature.properties.headline);
                  shownAlerts.add(alertId);
                }
              }
            }
            if (newAlertMessages.length > 0) {
              const fullMessage = newAlertMessages.join(' <span class="text-gray-500 mx-4">|||</span> ');
              const displayDuration = 60000 * newAlertMessages.length;
              showIPAWSAlert(fullMessage, displayDuration, 'alarm');
            }
          } catch (err) {
            console.error("IPAWS/NWS alert fetch failed:", err);
          }
        }
        
        // --- NEW: Firebase Real-time Alert Listener ---
        function initializeFirebaseListener() {
            try {
                if (!CONFIG.firebaseConfig || CONFIG.firebaseConfig.apiKey === "PASTE_YOUR_API_KEY") {
                    console.warn("Firebase is not configured in config.js. Remote manual alerts are disabled.");
                    return;
                }
                
                // Initialize Firebase
                firebase.initializeApp(CONFIG.firebaseConfig);
                const db = firebase.firestore();

                // Listen for changes to the 'manual_alert' document
                db.collection('alerts').doc('manual_alert')
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            console.log("Remote alert received:", doc.data());
                            const alertData = doc.data();

                            if (alertData && alertData.message && alertData.duration) {
                                let displayMessage = '';
                                if (alertData.title) {
                                    displayMessage = `<div class="text-center"><h1 class="text-6xl md:text-7xl font-black mb-4">${alertData.title}</h1><p class="text-4xl md:text-5xl font-bold">${alertData.message}</p></div>`;
                                } else {
                                    displayMessage = alertData.message;
                                }
                                showIPAWSAlert(displayMessage, alertData.duration, alertData.tone || 'default');
                                
                                // After showing the alert, delete it from the database so it doesn't reappear on other dashboards
                                // that might load later or on a page refresh. We add a small delay to give other live dashboards
                                // a chance to receive the alert before it's deleted.
                                setTimeout(() => {
                                    doc.ref.delete().catch(e => console.error("Error deleting alert from Firestore:", e));
                                }, 2000); 
                            }
                        }
                    }, (error) => {
                        console.error("Error with Firestore listener: ", error);
                    });

            } catch(e) {
                console.error("Failed to initialize Firebase listener:", e);
            }
        }


        // ------------------------------
        // Toolbar Weather Widget
        // ------------------------------
        async function fetchToolbarWeather() {
            // ... (this function remains unchanged)
            const weather = CONFIG.weatherConfig;
            const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${weather.latitude}&longitude=${weather.longitude}&current=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min&temperature_unit=fahrenheit&timezone=auto`;
            const tempEl = document.getElementById('weather-temp');
            const conditionEl = document.getElementById('weather-condition');
            const highLowEl = document.getElementById('weather-high-low');
            const locationEl = document.getElementById('weather-location');
            const CONDITIONS = { 0: "Clear", 1: "Clear", 2: "Cloudy", 3: "Overcast", 45: "Fog", 48: "Fog", 51: "Drizzle", 53: "Drizzle", 55: "Drizzle", 56: "Freezing Drizzle", 57: "Freezing Drizzle", 61: "Rain", 63: "Rain", 65: "Rain", 66: "Freezing Rain", 67: "Freezing Rain", 71: "Snow", 73: "Snow", 75: "Snow", 77: "Snow", 80: "Showers", 81: "Showers", 82: "Showers", 85: "Snow Showers", 86: "Snow Showers", 95: "Thunderstorm", 96: "Thunderstorm", 99: "Thunderstorm" };

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error("Failed to fetch weather");
                const data = await response.json();
                const temp = Math.round(data.current.temperature_2m);
                const high = Math.round(data.daily.temperature_2m_max[0]);
                const low = Math.round(data.daily.temperature_2m_min[0]);
                const condition = CONDITIONS[data.current.weather_code] || 'N/A';
                tempEl.textContent = `${temp}°`;
                conditionEl.textContent = condition;
                locationEl.textContent = weather.locationName;
                highLowEl.textContent = `H: ${high}° L: ${low}°`;
            } catch (error) {
                console.error("Toolbar weather fetch failed:", error);
                conditionEl.textContent = 'Weather unavailable';
                tempEl.textContent = '--°';
                highLowEl.textContent = 'H: --° L: --°';
            }
        }

        // Initial calls and intervals
        fetchIPAWSAlerts();
        fetchToolbarWeather();
        initializeFirebaseListener(); // <-- Listen for remote alerts
        setInterval(fetchIPAWSAlerts, IPAWS_CONFIG.REFRESH_INTERVAL_SECONDS * 1000);
        setInterval(fetchToolbarWeather, CONFIG.weatherConfig.refreshIntervalMinutes * 60 * 1000);
    });
  </script>

</body>
</html>



