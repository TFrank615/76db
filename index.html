<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HARMONY TOWNSHIP DASHBOARD</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <style>
    /* General body and layout setup */
    html, body {
      margin: 0;
      padding: 0;
      height: 100vh;
      width: 100vw;
      font-family: Arial, sans-serif;
      overflow: hidden; /* Prevent scrolling on the main page */
    }
    body {
      display: flex;
      background: #000;
    }
    .toolbar {
      width: 250px;
      background: #1F2937;
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      padding: 20px 10px;
      flex-shrink: 0;
      z-index: 10;
    }
    .logo {
      max-width: 100%;
      height: 20;
      border-radius: 8px;
    }
    .slides {
      flex-grow: 1;
      height: 100vh;
      position: relative;
    }
    .slide {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      transition: opacity 1s ease-in-out;
    }
    .slide.visible {
      opacity: 1;
    }
    .slide iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    #nwsAlertOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      color: #ff4444;
      font-size: 42px;
      font-weight: bold;
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      z-index: 9999;
      visibility: hidden;
      padding: 20px;
      line-height: 1.3;
      opacity: 0;
      transition: visibility 0s, opacity 0.5s linear;
    }
    #nwsAlertOverlay.visible {
        visibility: visible;
        opacity: 1;
    }
    
    /* NEW: Styles for the custom weather widget in the toolbar */
    #toolbar-weather-widget {
        width: 100%;
        height: 150%;
        display: block;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 5px;
        box-sizing: border-box;
    }
    #toolbar-weather-widget .temp {
        font-size: 4rem; /* 48px */
        font-weight: bold;
    }
    #toolbar-weather-widget .condition {
        font-size: 1.250rem; /* 18px */
        margin-top: -5px;
        color: #d1d5db; /* Lighter gray */
    }
    #toolbar-weather-widget .location {
        font-size: 1.750rem; /* 16px */
        font-weight: bold;
        margin-top: 5px;
    }
    #toolbar-weather-widget .high-low {
        font-size: 1.125rem; /* 14px */
        margin-top: 5px;
        color: #9ca3af; /* Gray */
    }

    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }
      .toolbar {
        width: 100%;
        height: 150px;
        flex-direction: row;
        justify-content: space-around;
      }
      .slides {
        height: calc(100vh - 150px);
      }
      #nwsAlertOverlay {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>

  <div class="toolbar">
    <div>
      <img src="logo.png" alt="Harmony Township Logo" class="logo">
    </div>

    <div id="toolbar-weather-widget">
        <p class="location">Loading...</p>
    </div>
    
    <iframe title="Time and Date Clock" src="https://free.timeanddate.com/clock/ia164w8b/n805/fn2/fs30/fcfff/tct/pct/ftb/pb5/tt0/tw0/tm1/th1/tb4" frameborder="0" display=block width=100% height=75% allowtransparency="true"></iframe>
  </div>

  <div class="slides" id="slidesContainer">
    <div class="slide"></div>
    <div class="slide"></div>
  </div>

  <div id="nwsAlertOverlay">ALERT MESSAGE</div>

  <audio id="alertSound"></audio>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <script src="config.js"></script>

  <script>
    // ------------------------------
    // Audio Context and Sound Generation
    // ------------------------------
    let audioEnabled = false;
    const alertSynth = new Tone.Synth({
        oscillator: { type: 'square' },
        envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.2 }
    }).toDestination();

    function playAlertSound() {
        if (!audioEnabled) return;
        const now = Tone.now();
        alertSynth.triggerAttackRelease('C5', '8n', now);
        alertSynth.triggerAttackRelease('G4', '8n', now + 0.2);
        alertSynth.triggerAttackRelease('C5', '8n', now + 0.4);
    }

    function enableAudio() {
      if (audioEnabled) return;
      Tone.start();
      audioEnabled = true;
      console.log('Audio context started.');
      window.removeEventListener('click', enableAudio);
      window.removeEventListener('keydown', enableAudio);
    }
    window.addEventListener('click', enableAudio);
    window.addEventListener('keydown', enableAudio);

    // ------------------------------
    // Slide Rotation Logic
    // ------------------------------
    const sources = [
      {
        iframe: `<iframe title="Google Slides" src="googleslides.html" frameborder="0"></iframe>`,
        duration: 30000
      },
      {
        iframe: `<iframe title="Weather Radar" src="weather_radar.html" frameborder="0"></iframe>`,
        duration: 20000
      },
      {
        iframe: '<iframe title="News Feed" src="news.html" frameborder="0" allowfullscreen="true"></iframe>',
        duration: 20000
      },
      {
        iframe: '<iframe title="Maintenance" src="maintenance.html" frameborder="0" allowfullscreen="true"></iframe>',
        duration: 20000
      },
      {
        iframe: '<iframe title="Trainings" src="trainings.html" frameborder="0" allowfullscreen="true"></iframe>',
        duration: 20000
      },
      {
        iframe: '<iframe title="EMS Schedule" src="schedule.html" frameborder="0" allowfullscreen="true"></iframe>',
        duration: 20000
      },
      {
        iframe: `<iframe title="Weather Forecast" src="weather.html" frameborder="0"></iframe>`,
        duration: 20000
      },
      
    ];

    const slideDivs = document.querySelectorAll('.slide');
    let contentIndex = 0;
    let activeSlideIndex = 0;

    function scheduleNextSlide(duration) {
        setTimeout(() => {
          contentIndex = (contentIndex + 1) % sources.length;
          rotateSlides();
        }, duration);
    }

    function rotateSlides() {
      const nextSlideIndex = 1 - activeSlideIndex;
      const currentSlide = slideDivs[activeSlideIndex];
      const nextSlide = slideDivs[nextSlideIndex];
      const source = sources[contentIndex];

      nextSlide.innerHTML = source.iframe;
      const iframe = nextSlide.querySelector('iframe');
      
      const transition = () => {
        if (nextSlide.classList.contains('visible')) return;
        currentSlide.classList.remove('visible');
        nextSlide.classList.add('visible');
        activeSlideIndex = nextSlideIndex;
        scheduleNextSlide(source.duration);
      };
      
      iframe.onload = transition;
      iframe.onerror = () => {
        console.error("Iframe failed to load:", source.iframe);
        transition();
      };
      
      setTimeout(() => transition(), 500);
    }

    function startRotation() {
      const firstSource = sources[0];
      slideDivs[0].innerHTML = firstSource.iframe;
      const firstIframe = slideDivs[0].querySelector('iframe');

      const transition = () => {
          if (slideDivs[0].classList.contains('visible')) return;
          slideDivs[0].classList.add('visible');
          activeSlideIndex = 0;
          setTimeout(() => {
              contentIndex = 1;
              rotateSlides();
          }, firstSource.duration);
      };

      firstIframe.onload = transition;
      firstIframe.onerror = () => {
          console.error("First iframe failed to load:", firstSource.iframe);
          transition();
      };
      setTimeout(() => transition(), 500);
    }

    startRotation();

    // ------------------------------
    // NWS Alert System
    // ------------------------------
    const shownAlerts = new Set();

    async function fetchNWSAlerts() {
      try {
        const zone = CONFIG.nwsAlertZone || 'OHZ053';
        const response = await fetch(`https://api.weather.gov/alerts/active/zone/${zone}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();

        if (data.features && data.features.length > 0) {
          for (const feature of data.features) {
            const alertId = feature.id;
            if (!shownAlerts.has(alertId)) {
              const alert = feature.properties;
              if (['Severe', 'Extreme'].includes(alert.severity)) {
                  const message = `${alert.headline}`;
                  showNWSAlert(message, 60000);
                  shownAlerts.add(alertId);
                  break;
              }
            }
          }
        }
      } catch (err) {
        console.error("NWS alert fetch failed:", err);
      }
    }

    function showNWSAlert(message, duration) {
      const overlay = document.getElementById("nwsAlertOverlay");
      overlay.textContent = message;
      overlay.classList.add('visible');
      playAlertSound();
      setTimeout(() => {
        overlay.classList.remove('visible');
      }, duration);
    }

    // ------------------------------
    // NEW: Toolbar Weather Widget
    // ------------------------------
    const WEATHER_CONFIG = {
        LATITUDE: 39.95, // South Vienna, Ohio
        LONGITUDE: -83.6,
        LOCATION_NAME: "South Vienna, OH",
        REFRESH_INTERVAL_MINUTES: 15,
        // Simplified weather codes for the widget
        CONDITIONS: {
            0: "Clear", 1: "Clear", 2: "Cloudy", 3: "Overcast", 45: "Fog", 48: "Fog",
            51: "Drizzle", 53: "Drizzle", 55: "Drizzle", 56: "Freezing Drizzle", 57: "Freezing Drizzle",
            61: "Rain", 63: "Rain", 65: "Rain", 66: "Freezing Rain", 67: "Freezing Rain",
            71: "Snow", 73: "Snow", 75: "Snow", 77: "Snow",
            80: "Showers", 81: "Showers", 82: "Showers", 85: "Snow Showers", 86: "Snow Showers",
            95: "Thunderstorm", 96: "Thunderstorm", 99: "Thunderstorm"
        }
    };

    async function fetchToolbarWeather() {
        const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${WEATHER_CONFIG.LATITUDE}&longitude=${WEATHER_CONFIG.LONGITUDE}&current=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min&temperature_unit=fahrenheit&timezone=auto`;
        const widget = document.getElementById('toolbar-weather-widget');

        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error("Failed to fetch weather");
            const data = await response.json();

            const temp = Math.round(data.current.temperature_2m);
            const high = Math.round(data.daily.temperature_2m_max[0]);
            const low = Math.round(data.daily.temperature_2m_min[0]);
            const condition = WEATHER_CONFIG.CONDITIONS[data.current.weather_code] || 'N/A';

            widget.innerHTML = `
                <p class="temp">${temp}°</p>
                <p class="condition">${condition}</p>
                <p class="location">${WEATHER_CONFIG.LOCATION_NAME}</p>
                <p class="high-low">H: ${high}° L: ${low}°</p>
            `;

        } catch (error) {
            console.error("Toolbar weather fetch failed:", error);
            widget.innerHTML = `<p class="location">Weather unavailable</p>`;
        }
    }

    // Initial calls and intervals
    fetchNWSAlerts();
    fetchToolbarWeather();
    setInterval(fetchNWSAlerts, 300000);
    setInterval(fetchToolbarWeather, WEATHER_CONFIG.REFRESH_INTERVAL_MINUTES * 60 * 1000);
  </script>

<iframe src="ticker.html" style="position: fixed; bottom: 0; left: 0; width: 100%; height: 80px; border: none; z-index: 999;"></iframe>

</body>
</html>
