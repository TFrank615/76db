<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HARMONY TOWNSHIP DASHBOARD</title>
  <!-- Using a placeholder favicon for completeness -->
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <style>
    /* General body and layout setup */
    html, body {
      margin: 0;
      padding: 0;
      height: 100vh;
      width: 100vw;
      font-family: Arial, sans-serif;
      overflow: hidden; /* Prevent scrolling on the main page */
    }

    /* Use Flexbox for a more modern and robust layout */
    body {
      display: flex;
    }

    /* Toolbar fixed on the left */
    .toolbar {
      width: 250px;
      background: #000000;
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      padding: 20px 10px;
      flex-shrink: 0; /* Prevent the toolbar from shrinking */
      z-index: 10;
    }

    /* Logo at top */
    .logo {
      max-width: 100%; /* Make logo responsive within the toolbar */
      height: auto;
      border-radius: 8px; /* Soften edges */
    }

    /* Main content area for the slides */
    .slides {
      flex-grow: 1; /* Allow slides to take up the remaining space */
      height: 100vh;
      position: relative; /* Required for positioning slide children */
    }

    /* Slide containers for smooth transition */
    .slide {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0; /* Hidden by default */
      transition: opacity 1s ease-in-out; /* Smooth fade effect */
    }

    .slide.visible {
      opacity: 1; /* Visible state */
    }

    /* Ensure iframes fill their container */
    .slide iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* Dashboard title under logo */
    .title {
      margin-top: 20px;
      font-size: 16px;
      text-align: center;
      font-weight: bold;
      text-transform: uppercase;
    }

    /* NWS Alert Overlay */
    #nwsAlertOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      color: #ff4444;
      font-size: 42px;
      font-weight: bold;
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      z-index: 9999;
      visibility: hidden; /* Hidden by default */
      padding: 20px;
      line-height: 1.3;
      opacity: 0;
      transition: visibility 0s, opacity 0.5s linear;
    }

    #nwsAlertOverlay.visible {
        visibility: visible;
        opacity: 1;
    }

    /* IMPROVEMENT: Media query for better responsiveness on smaller screens */
    @media (max-width: 768px) {
      body {
        flex-direction: column; /* Stack toolbar and slides vertically */
      }
      .toolbar {
        width: 100%;
        height: 150px; /* Give toolbar a fixed height */
        flex-direction: row; /* Arrange items horizontally */
        justify-content: space-around;
      }
      .slides {
        height: calc(100vh - 150px); /* Adjust height to fill remaining space */
      }
      .title {
        display: none; /* Hide title on small screens to save space */
      }
      #nwsAlertOverlay {
        font-size: 24px; /* Make alert text smaller on mobile */
      }
    }
  </style>
</head>
<body>

  <div class="toolbar">
    <div>
      <!-- CHANGED: Using a placeholder for the logo -->
      <img src="logo.png" alt="Harmony Township Logo" class="logo">
    </div>
    <!-- ADDED: title attribute for accessibility -->
    <iframe title="Common Ninja Widget" src="https://widgets.commoninja.com/iframe/c4d28163-89c5-4a2e-a0bd-1721d1a7018d" width="95%" height="100%" frameborder="0" scrolling="no"></iframe>
    <!-- ADDED: title attribute for accessibility -->
    <iframe title="Time and Date Clock" src="https://free.timeanddate.com/clock/ia164w8b/n805/fn2/fs30/fcfff/tct/pct/ftb/pb5/tt0/tw0/tm1/th1/tb4" frameborder="0" width="219" height="120" allowtransparency="true"></iframe>
  </div>

  <div class="slides" id="slidesContainer">
    <!-- Two slide divs for the cross-fade effect -->
    <div class="slide"></div>
    <div class="slide"></div>
  </div>

  <div id="nwsAlertOverlay">ALERT MESSAGE</div>

  <!-- This audio element is now controlled by Tone.js, no src needed -->
  <audio id="alertSound"></audio>

  <!-- ADDED: Tone.js for generating audio tones without needing an MP3 file -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

  <script>
    // ------------------------------
    // Audio Context and Sound Generation
    // ------------------------------
    let audioEnabled = false;
    // Create a synth with Tone.js to generate an alert sound
    const alertSynth = new Tone.Synth({
        oscillator: { type: 'square' },
        envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.2 }
    }).toDestination();

    function playAlertSound() {
        if (!audioEnabled) return;
        // Play a sequence of notes for the alert
        const now = Tone.now();
        alertSynth.triggerAttackRelease('C5', '8n', now);
        alertSynth.triggerAttackRelease('G4', '8n', now + 0.2);
        alertSynth.triggerAttackRelease('C5', '8n', now + 0.4);
    }

    function enableAudio() {
      if (audioEnabled) return;
      Tone.start();
      audioEnabled = true;
      console.log('Audio context started.');
      // Remove listeners after first interaction
      window.removeEventListener('click', enableAudio);
      window.removeEventListener('keydown', enableAudio);
    }
    // Listen for the first user interaction to enable audio
    window.addEventListener('click', enableAudio);
    window.addEventListener('keydown', enableAudio);

    // ------------------------------
    // Slide Rotation Logic
    // ------------------------------
    const sources = [
      // CHANGED: Using srcdoc for local HTML pages to make this example self-contained.
      // You can switch back to src="schedule.html" when you have the file.
      
      {
        // FIXED: Added width="100%" and height="100%" to ensure it fills the container
        iframe: '<iframe title="Maintence" src="maintenance.html" width="100%" height="100%" frameborder="0" allowfullscreen="true"></iframe>',
        duration: 30000
      },
      {
        // FIXED: Added width="100%" and height="100%" to ensure it fills the container
        iframe: '<iframe title="Trainings" src="trainings.html" width="100%" height="100%" frameborder="0" allowfullscreen="true"></iframe>',
        duration: 30000
      },
      {
        // FIXED: Added width="100%" and height="100%" to ensure it fills the container
        iframe: '<iframe title="EMS Schedule" src="schedule.html" width="100%" height="100%" frameborder="0" allowfullscreen="true"></iframe>',
        duration: 30000
      },
      {
        // FIXED: Added width="100%" and height="100%" to ensure it fills the container
        iframe: '<iframe title="Public Service Announcements" src="https://docs.google.com/presentation/d/e/2PACX-1vSwcRaDaFHcBYOPvLNlsNATIDRqoApsB1UX11rVQFwUcRkKrqxb12k4PaiV_IFS1I8LvI_uVw2uqY82/pubembed?start=true&loop=true&delayms=15000&rm=minimal" width="100%" height="100%" frameborder="0" allowfullscreen="true"></iframe>',
        duration: 60000
      },
      {
        // This external Windy.com map remains the same
        iframe: `<iframe title="Weather Radar" src="https://embed.windy.com/embed.html?type=map&location=coordinates&metricRain=default&metricTemp=default&metricWind=mph&zoom=11&overlay=radar&product=radar&level=surface&lat=39.91&lon=-83.602" frameborder="0"></iframe>`,
        duration: 30000
      },
    ];

    const slideDivs = document.querySelectorAll('.slide');
    let contentIndex = 0;
    let activeSlideIndex = 0;

    function rotateSlides() {
      // Determine the next slide to show and the one to hide
      const nextSlideIndex = 1 - activeSlideIndex; // Toggles between 0 and 1
      const currentSlide = slideDivs[activeSlideIndex];
      const nextSlide = slideDivs[nextSlideIndex];

      const source = sources[contentIndex];

      // Load the new iframe into the currently hidden slide container
      nextSlide.innerHTML = source.iframe;
      const iframe = nextSlide.querySelector('iframe');

      // The 'load' event ensures the content is ready before we show it.
      // This is especially important for external iframes.
      iframe.onload = () => {
        // Fade out the current slide
        currentSlide.classList.remove('visible');
        // Fade in the new slide
        nextSlide.classList.add('visible');

        // Update the active slide index for the next rotation
        activeSlideIndex = nextSlideIndex;

        // Schedule the next slide change
        setTimeout(() => {
          contentIndex = (contentIndex + 1) % sources.length;
          rotateSlides();
        }, source.duration);
      };

      // A failsafe for iframes that might not fire the 'load' event (e.g., srcdoc).
      // We trigger the transition after a short delay.
      setTimeout(() => {
        if (!nextSlide.classList.contains('visible')) {
            iframe.onload(); // Manually trigger the transition
        }
      }, 500);
    }

    // Function to start the very first slide
    function startRotation() {
      const firstSource = sources[0];
      slideDivs[0].innerHTML = firstSource.iframe;
      
      // We wait for the first iframe to be ready before starting the cycle
      const firstIframe = slideDivs[0].querySelector('iframe');
      firstIframe.onload = () => {
        slideDivs[0].classList.add('visible');
        activeSlideIndex = 0;

        setTimeout(() => {
          contentIndex = 1;
          rotateSlides();
        }, firstSource.duration);
      };
       // Failsafe for the very first load
      setTimeout(() => {
        if (!slideDivs[0].classList.contains('visible')) {
            firstIframe.onload();
        }
      }, 500);
    }

    startRotation(); // Start the slideshow

    // ------------------------------
    // NWS Alert System
    // ------------------------------
    const shownAlerts = new Set();

    async function fetchNWSAlerts() {
      try {
        // Using a CORS proxy for development/testing if direct fetch fails.
        // For production, ensure the server allows requests from your domain.
        const response = await fetch("https://api.weather.gov/alerts/active/zone/OHZ053");
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();

        if (data.features && data.features.length > 0) {
          let hasNewAlert = false;
          for (const feature of data.features) {
            const alertId = feature.id;
            if (!shownAlerts.has(alertId)) {
              const alert = feature.properties;
              const message = `${alert.headline} - ${alert.description}`;
              showNWSAlert(message, 60000); // Show alert for 60 seconds
              shownAlerts.add(alertId);
              hasNewAlert = true;
              break; // Show one new alert at a time to avoid overlap
            }
          }
        }
      } catch (err) {
        console.error("NWS alert fetch failed:", err);
      }
    }

    function showNWSAlert(message, duration) {
      const overlay = document.getElementById("nwsAlertOverlay");
      overlay.textContent = message;
      overlay.classList.add('visible');

      playAlertSound(); // Play the generated sound

      setTimeout(() => {
        overlay.classList.remove('visible');
      }, duration);
    }

    // Initial check and then poll for new alerts
    fetchNWSAlerts();
    // CHANGED: Interval is now 5 minutes (300,000 ms) to be friendlier to the API
    setInterval(fetchNWSAlerts, 300000);
  </script>
</body>
</html>

