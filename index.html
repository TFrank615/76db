<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HARMONY TOWNSHIP DASHBOARD</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    /* Custom font family */
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-900 text-white flex flex-col h-screen w-screen overflow-hidden">

  <!-- Main content area (sidebar + slides) -->
  <div class="flex-grow flex flex-col md:flex-row min-h-0">
    <!-- Toolbar / Sidebar -->
    <aside class="w-full md:w-64 bg-gray-800 text-white flex md:flex-col justify-around md:justify-between items-center p-4 md:p-5 flex-shrink-0 z-20 shadow-lg">
      <div class="flex flex-col items-center text-center">
        <img src="logo.png" alt="Harmony Township Logo" class="w-40 md:w-60 h-auto rounded-lg">
      </div>

      <!-- Weather Widget -->
      <div id="toolbar-weather-widget" class="text-center">
          <p id="weather-temp" class="text-6xl font-black">--°</p>
          <p id="weather-condition" class="text-2xl text-gray-300 mt-2">Loading...</p>
          <p id="weather-location" class="text-xl font-bold mt-2">South Vienna</p>
          <p id="weather-high-low" class="text-md text-gray-400">H: --° L: --°</p>
      </div>
      
      <!-- Clock Container -->
      <div id="clock-container" class="w-48 md:w-full h-20 transition-all duration-300 ease-in-out">
          <iframe title="Time and Date Clock" src="https://free.timeanddate.com/clock/ia164w8b/n805/fn2/fs30/fcfff/tct/pct/ftb/pb5/tt0/tw0/tm1/th1/tb4" frameborder="0" class="w-full h-full" allowtransparency="true"></iframe>
      </div>
    </aside>

    <!-- Main Content Slides -->
    <main class="flex-grow h-full relative">
      <div class="slides" id="slidesContainer">
        <div class="slide absolute inset-0 w-full h-full opacity-0 transition-opacity duration-1000 ease-in-out"></div>
        <div class="slide absolute inset-0 w-full h-full opacity-0 transition-opacity duration-1000 ease-in-out"></div>
      </div>
    </main>
  </div>


  <!-- NWS Alert Overlay -->
  <div id="nwsAlertOverlay" class="fixed inset-0 bg-black bg-opacity-95 text-red-500 text-3xl md:text-5xl font-black flex justify-center items-center text-center z-[9999] p-5 leading-tight opacity-0 invisible transition-opacity duration-500">
    ALERT MESSAGE
  </div>
  
  <!-- Ticker Iframe -->
  <footer id="ticker-footer" class="fixed bottom-0 left-0 w-full h-20 z-50 hidden">
    <iframe src="ticker.html" class="w-full h-full border-none"></iframe>
  </footer>


  <audio id="alertSound"></audio>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <script src="config.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {

        // ------------------------------
        // Ticker Communication
        // ------------------------------
        window.addEventListener('message', (event) => {
            const tickerFooter = document.getElementById('ticker-footer');
            const clockContainer = document.getElementById('clock-container');
            
            if (event.data && typeof event.data.tickerActive !== 'undefined') {
                if (event.data.tickerActive) {
                    tickerFooter.classList.remove('hidden');
                    // Add margin to the clock on medium screens and up to avoid overlap
                    clockContainer.classList.add('md:mb-20');
                } else {
                    tickerFooter.classList.add('hidden');
                    // Remove the margin when ticker is inactive
                    clockContainer.classList.remove('md:mb-20');
                }
            }
        });

        // ------------------------------
        // Audio Context and Sound Generation
        // ------------------------------
        let audioEnabled = false;
        const alertSynth = new Tone.Synth({
            oscillator: { type: 'square' },
            envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.2 }
        }).toDestination();

        function playAlertSound() {
            if (!audioEnabled) return;
            const now = Tone.now();
            alertSynth.triggerAttackRelease('C5', '8n', now);
            alertSynth.triggerAttackRelease('G4', '8n', now + 0.2);
            alertSynth.triggerAttackRelease('C5', '8n', now + 0.4);
        }

        function enableAudio() {
          if (audioEnabled) return;
          Tone.start();
          audioEnabled = true;
          console.log('Audio context started.');
          window.removeEventListener('click', enableAudio);
          window.removeEventListener('keydown', enableAudio);
        }
        window.addEventListener('click', enableAudio);
        window.addEventListener('keydown', enableAudio);

        // ------------------------------
        // Slide Rotation Logic
        // ------------------------------
        const sources = [
          { iframe: `<iframe title="Google Slides" src="googleslides.html" frameborder="0" class="w-full h-full"></iframe>`, duration: 45000 },
          { iframe: `<iframe title="Weather Radar" src="weather_radar.html" frameborder="0" class="w-full h-full"></iframe>`, duration: 20000 },
          { iframe: '<iframe title="News Feed" src="news.html" frameborder="0" allowfullscreen="true" class="w-full h-full"></iframe>', duration: 20000 }, // Example of a skipped slide
          { iframe: '<iframe title="Maintenance" src="maintenance.html" frameborder="0" allowfullscreen="true" class="w-full h-full"></iframe>', duration: 20000 },
          { iframe: '<iframe title="Trainings" src="googlecalander.html" frameborder="0" allowfullscreen="true" class="w-full h-full"></iframe>', duration: 20000 },
          { iframe: '<iframe title="EMS Schedule" src="schedule.html" frameborder="0" allowfullscreen="true" class="w-full h-full"></iframe>', duration: 20000 },
          { iframe: `<iframe title="Weather Forecast" src="weather.html" frameborder="0" class="w-full h-full"></iframe>`, duration: 20000 },
          { iframe: `<iframe title="Stats 1" src="stats1.html" frameborder="0" class="w-full h-full"></iframe>`, duration: 20000 },
        ];

        const slideDivs = document.querySelectorAll('.slide');
        let contentIndex = 0;
        let activeSlideIndex = 0;

        function scheduleNextSlide(duration) {
            setTimeout(() => {
              contentIndex = (contentIndex + 1) % sources.length;
              rotateSlides();
            }, duration);
        }

        function rotateSlides() {
          // Find the next source that has a duration greater than 0
          let source = sources[contentIndex];
          const initialIndex = contentIndex;

          while (source.duration === 0) {
            contentIndex = (contentIndex + 1) % sources.length;
            source = sources[contentIndex];
            // If we've looped through all sources and all have a duration of 0, stop to prevent an infinite loop.
            if (contentIndex === initialIndex) {
              console.error("All slides have a duration of 0. Halting rotation.");
              return; 
            }
          }

          const nextSlideIndex = 1 - activeSlideIndex;
          const currentSlide = slideDivs[activeSlideIndex];
          const nextSlide = slideDivs[nextSlideIndex];
          
          nextSlide.innerHTML = source.iframe;
          const iframe = nextSlide.querySelector('iframe');
          
          const transition = () => {
            if (nextSlide.classList.contains('opacity-100')) return; // Already visible
            currentSlide.classList.remove('opacity-100');
            currentSlide.classList.add('opacity-0');
            
            nextSlide.classList.remove('opacity-0');
            nextSlide.classList.add('opacity-100');

            activeSlideIndex = nextSlideIndex;
            scheduleNextSlide(source.duration);
          };
          
          iframe.onload = transition;
          iframe.onerror = () => {
            console.error("Iframe failed to load:", source.iframe);
            transition();
          };
          
          // Failsafe timeout in case onload doesn't fire
          setTimeout(transition, 500);
        }

        function startRotation() {
          const firstSource = sources[0];
          slideDivs[0].innerHTML = firstSource.iframe;
          const firstIframe = slideDivs[0].querySelector('iframe');

          const transition = () => {
              if (slideDivs[0].classList.contains('opacity-100')) return; // Already visible
              slideDivs[0].classList.remove('opacity-0');
              slideDivs[0].classList.add('opacity-100');
              activeSlideIndex = 0;
              // If the first slide has a duration of 0, this will fire immediately
              setTimeout(() => {
                  contentIndex = 1;
                  rotateSlides();
              }, firstSource.duration);
          };

          firstIframe.onload = transition;
          firstIframe.onerror = () => {
              console.error("First iframe failed to load:", firstSource.iframe);
              transition();
          };
          // Failsafe timeout
          setTimeout(transition, 500);
        }

        startRotation();

        // ------------------------------
        // NWS Alert System
        // ------------------------------
        const shownAlerts = new Set();

        async function fetchNWSAlerts() {
          try {
            const zone = CONFIG.nwsAlertZone || 'OHZ053';
            const response = await fetch(`https://api.weather.gov/alerts/active/zone/${zone}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            if (data.features && data.features.length > 0) {
              for (const feature of data.features) {
                const alertId = feature.id;
                if (!shownAlerts.has(alertId)) {
                  const alert = feature.properties;
                  if (['Severe', 'Extreme'].includes(alert.severity)) {
                      const message = `${alert.headline}`;
                      showNWSAlert(message, 60000);
                      shownAlerts.add(alertId);
                      break; // Show only the first new severe/extreme alert
                  }
                }
              }
            }
          } catch (err) {
            console.error("NWS alert fetch failed:", err);
          }
        }

        function showNWSAlert(message, duration) {
          const overlay = document.getElementById("nwsAlertOverlay");
          overlay.textContent = message;
          overlay.classList.remove('invisible', 'opacity-0');
          overlay.classList.add('opacity-100');
          playAlertSound();
          setTimeout(() => {
            overlay.classList.remove('opacity-100');
            overlay.classList.add('invisible', 'opacity-0');
          }, duration);
        }

        // ------------------------------
        // Toolbar Weather Widget
        // ------------------------------
        const WEATHER_CONFIG = {
            LATITUDE: 39.95, // South Vienna, Ohio
            LONGITUDE: -83.6,
            LOCATION_NAME: "South Vienna",
            REFRESH_INTERVAL_MINUTES: 15,
            CONDITIONS: {
                0: "Clear", 1: "Clear", 2: "Cloudy", 3: "Overcast", 45: "Fog", 48: "Fog",
                51: "Drizzle", 53: "Drizzle", 55: "Drizzle", 56: "Freezing Drizzle", 57: "Freezing Drizzle",
                61: "Rain", 63: "Rain", 65: "Rain", 66: "Freezing Rain", 67: "Freezing Rain",
                71: "Snow", 73: "Snow", 75: "Snow", 77: "Snow",
                80: "Showers", 81: "Showers", 82: "Showers", 85: "Snow Showers", 86: "Snow Showers",
                95: "Thunderstorm", 96: "Thunderstorm", 99: "Thunderstorm"
            }
        };

        async function fetchToolbarWeather() {
            const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${WEATHER_CONFIG.LATITUDE}&longitude=${WEATHER_CONFIG.LONGITUDE}&current=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min&temperature_unit=fahrenheit&timezone=auto`;
            const tempEl = document.getElementById('weather-temp');
            const conditionEl = document.getElementById('weather-condition');
            const highLowEl = document.getElementById('weather-high-low');
            const locationEl = document.getElementById('weather-location');

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error("Failed to fetch weather");
                const data = await response.json();

                const temp = Math.round(data.current.temperature_2m);
                const high = Math.round(data.daily.temperature_2m_max[0]);
                const low = Math.round(data.daily.temperature_2m_min[0]);
                const condition = WEATHER_CONFIG.CONDITIONS[data.current.weather_code] || 'N/A';

                tempEl.textContent = `${temp}°`;
                conditionEl.textContent = condition;
                locationEl.textContent = WEATHER_CONFIG.LOCATION_NAME;
                highLowEl.textContent = `H: ${high}° L: ${low}°`;

            } catch (error) {
                console.error("Toolbar weather fetch failed:", error);
                conditionEl.textContent = 'Weather unavailable';
                tempEl.textContent = '--°';
                highLowEl.textContent = 'H: --° L: --°';
            }
        }

        // Initial calls and intervals
        fetchNWSAlerts();
        fetchToolbarWeather();
        setInterval(fetchNWSAlerts, 300000); // 5 minutes
        setInterval(fetchToolbarWeather, WEATHER_CONFIG.REFRESH_INTERVAL_MINUTES * 60 * 1000);
    });
  </script>

</body>
</html>
